name: Integration Tests

on:
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  integration:
    name: Integration (${{ matrix.airflow_version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - airflow_version: "2.10.4"
            api_version: "v1"
          - airflow_version: "3.0.1"
            api_version: "v2"

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Start Airflow container
        run: |
          docker run -d --name airflow \
            -p 8080:8080 \
            -e AIRFLOW__CORE__LOAD_EXAMPLES=true \
            -e AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:////tmp/airflow.db \
            -e AIRFLOW__WEBSERVER__SECRET_KEY=test-secret-key \
            -e AIRFLOW__API__AUTH_BACKENDS=airflow.api.auth.backend.basic_auth \
            --entrypoint /bin/bash \
            apache/airflow:${{ matrix.airflow_version }} \
            -c "sleep infinity"

      - name: Start Airflow services
        run: |
          docker exec airflow bash -c "
            airflow db migrate &&
            airflow users create --username airflow --password airflow --firstname Test --lastname User --role Admin --email test@example.com &&
            airflow webserver --port 8080 &
            airflow scheduler &
            sleep 30
          "

      - name: Wait for Airflow API
        run: |
          timeout 120 bash -c '
            until curl -sf -u airflow:airflow http://localhost:8080/api/v1/health; do
              echo "Waiting for Airflow API..."
              sleep 5
            done
          '
          echo "Airflow API is ready"

      - name: Run integration tests
        env:
          TEST_AIRFLOW_URL: http://localhost:8080
          TEST_AIRFLOW_USERNAME: airflow
          TEST_AIRFLOW_PASSWORD: airflow
          TEST_API_VERSION: ${{ matrix.api_version }}
        run: cargo test --test '*' -- --test-threads=1

      - name: Cleanup
        if: always()
        run: docker rm -f airflow || true

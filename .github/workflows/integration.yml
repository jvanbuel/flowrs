name: Integration Tests

on:
  push:
    branches: [main]

env:
  CARGO_TERM_COLOR: always

jobs:
  integration:
    name: Integration (${{ matrix.airflow_version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          - airflow_version: "2.10.4"
            api_version: "v1"
          - airflow_version: "3.1.6"
            api_version: "v2"

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable

      - uses: Swatinem/rust-cache@v2

      - name: Start Airflow 2.x container
        if: matrix.api_version == 'v1'
        run: |
          docker run -d --name airflow \
            -p 8080:8080 \
            -e AIRFLOW__CORE__LOAD_EXAMPLES=true \
            -e AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:////tmp/airflow.db \
            -e AIRFLOW__WEBSERVER__SECRET_KEY=test-secret-key \
            -e AIRFLOW__API__AUTH_BACKENDS=airflow.api.auth.backend.basic_auth \
            --entrypoint /bin/bash \
            apache/airflow:${{ matrix.airflow_version }} \
            -c "sleep infinity"

      - name: Start Airflow 3.x container
        if: matrix.api_version == 'v2'
        run: |
          docker run -d --name airflow \
            -p 8080:8080 \
            -e AIRFLOW__CORE__LOAD_EXAMPLES=true \
            -e AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=sqlite:////tmp/airflow.db \
            -e AIRFLOW__WEBSERVER__SECRET_KEY=test-secret-key \
            -e AIRFLOW__CORE__SIMPLE_AUTH_MANAGER_USERS=airflow:admin \
            --entrypoint /bin/bash \
            apache/airflow:${{ matrix.airflow_version }} \
            -c "sleep infinity"

      - name: Initialize Airflow database
        run: |
          docker exec airflow airflow db migrate

      - name: Create Airflow user (v2.x only)
        if: matrix.api_version == 'v1'
        run: |
          docker exec airflow airflow users create \
            --username airflow \
            --password airflow \
            --firstname Test \
            --lastname User \
            --role Admin \
            --email test@example.com

      - name: Start Airflow services (v2.x)
        if: matrix.api_version == 'v1'
        run: |
          docker exec -d airflow airflow webserver --port 8080
          docker exec -d airflow airflow scheduler

      - name: Start Airflow services (v3.x)
        if: matrix.api_version == 'v2'
        run: |
          docker exec -d airflow airflow api-server --port 8080
          docker exec -d airflow airflow scheduler
          docker exec -d airflow airflow dag-processor

      - name: Wait for Airflow API (v2.x)
        if: matrix.api_version == 'v1'
        run: |
          timeout 120 bash -c '
            until curl -sf -u airflow:airflow http://localhost:8080/api/v1/health; do
              echo "Waiting for Airflow API..."
              sleep 5
            done
          '
          echo "Airflow API is ready"

      - name: Wait for Airflow API (v3.x)
        if: matrix.api_version == 'v2'
        run: |
          timeout 120 bash -c '
            until curl -sf http://localhost:8080/api/v2/version; do
              echo "Waiting for Airflow API..."
              sleep 5
            done
          '
          echo "Airflow API is ready"

      - name: Get Airflow 3.x password
        if: matrix.api_version == 'v2'
        id: airflow_password
        run: |
          # Password file is generated by api-server, find it
          echo "Looking for password file..."
          docker exec airflow find /opt/airflow /home/airflow -name "*.generated" 2>/dev/null || true
          docker exec airflow ls -la /opt/airflow/ 2>/dev/null || true

          # Try common locations
          PASSWORD=""
          for path in /opt/airflow/simple_auth_manager_passwords.json.generated /home/airflow/simple_auth_manager_passwords.json.generated; do
            if docker exec airflow test -f "$path" 2>/dev/null; then
              echo "Found password file at $path"
              docker exec airflow cat "$path"
              PASSWORD=$(docker exec airflow cat "$path" | python3 -c "import sys, json; print(json.load(sys.stdin).get('airflow', ''))")
              break
            fi
          done

          if [ -z "$PASSWORD" ]; then
            echo "ERROR: Could not retrieve password from password file"
            exit 1
          fi

          echo "password=$PASSWORD" >> $GITHUB_OUTPUT
          echo "Successfully retrieved password for airflow user"

      - name: Wait for DAGs to load
        run: |
          echo "Waiting for scheduler to parse DAGs..."
          sleep 45

      - name: Run integration tests
        env:
          TEST_AIRFLOW_URL: http://localhost:8080
          TEST_AIRFLOW_USERNAME: airflow
          TEST_AIRFLOW_PASSWORD: ${{ matrix.api_version == 'v2' && steps.airflow_password.outputs.password || 'airflow' }}
          TEST_API_VERSION: ${{ matrix.api_version }}
        run: cargo test --test '*' -- --test-threads=1

      - name: Cleanup
        if: always()
        run: docker rm -f airflow || true
